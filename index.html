<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VoltageReference: ⚠ &lt;strong&gt;IMPORTANT&lt;/strong&gt;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">VoltageReference
   </div>
   <div id="projectbrief">Arduino voltage reference library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">⚠ <b>IMPORTANT</b> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_README"></a> </p><blockquote class="doxtable">
<p >Please, before submitting a support request read carefully this README and check if an answer already exists among <a href="https://github.com/rlogiacco/VoltageReference/discussions">previously answered questions</a>: do not abuse of the Github issue tracker. </p>
</blockquote>
<h1><a class="el" href="class_voltage_reference.html">VoltageReference</a> <a href="https://github.com/rlogiacco/VoltageReference/stargazers"><img src="https://img.shields.io/github/stars/rlogiacco/VoltageReference.svg?style=social&amp;label=Star" alt="GitHub stars" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/rlogiacco/VoltageReference/network"><img src="https://img.shields.io/github/forks/rlogiacco/VoltageReference.svg?style=social&amp;label=Fork" alt="GitHub forks" style="pointer-events: none;" class="inline"/></a> <a href="https://twitter.com/intent/tweet?text=Improve%20analog%20sensing%20accuracy%20on%20embedded%20devices%20easily!&amp;url=https://github.com/rlogiacco/VoltageReference&amp;hashtags=IoT,Arduino,ESP8266,ESP32"><img src="https://img.shields.io/twitter/url/http/shields.io.svg?style=social" alt="Tweet" style="pointer-events: none;" class="inline"/></a> </h1>
<p ><a href="https://github.com/rlogiacco/VoltageReference/releases"><img src="https://img.shields.io/github/release/rlogiacco/VoltageReference.svg" alt="GitHub version" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/rlogiacco/VoltageReference/releases/latest"><img src="https://img.shields.io/github/downloads/rlogiacco/VoltageReference/total.svg" alt="GitHub download" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/rlogiacco/VoltageReference/stargazers"><img src="https://img.shields.io/github/stars/rlogiacco/VoltageReference.svg" alt="GitHub stars" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/rlogiacco/VoltageReference/issues"><img src="https://img.shields.io/github/issues/rlogiacco/VoltageReference.svg" alt="GitHub issues" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/rlogiacco/VoltageReference/actions/workflows/main.yml"><img src="https://github.com/rlogiacco/VoltageReference/actions/workflows/main.yml/badge.svg" alt="Build Status" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/rlogiacco/VoltageReference/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-LGPL%203-blue.svg" alt="License" style="pointer-events: none;" class="inline"/></a></p>
<p >Many projects need to know the voltage present at their Vcc pin (also referred as 5V or 3V3), sometimes to monitor their own battery level (voltage gets lower during discharge), sometimes to level up analog reads (reading an analog pin implies a voltage comparison).</p>
<p >Most Atmel microcontrollers embed an internal voltage reference which can be used for these purposes and this library helps to simplify operating with them.</p>
<p >There is no wiring required as this library operates with internal microcontroller components only, but if you want to calibrate your board/microcontroller (highly recommended) two wires and a multimeter will be necessary.</p>
<p >Contributions are welcome under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache Public License version 2.0</a>.</p>
<p >For wiring instructions for calibration please refer to the <a href="https://raw.githubusercontent.com/rlogiacco/VoltageReference/master/examples/EEPROMCalibration/calibration.png">sample breadboard</a>.</p>
<blockquote class="doxtable">
<p ><b>NOTE</b>, if your goal is to monitor the battery level of a battery powered project, please refer to my <a href="https://github.com/rlogiacco/BatterySense">BatterySense</a> project. </p>
</blockquote>
<p>This library is largely based on <a href="http://forum.arduino.cc/index.php?action=profile;u=10859">Coding Badly</a>'s and <a href="http://provideyourown.com/2012/secret-arduino-voltmeter-measure-battery-voltage/">Scott Daniels</a>' work: I just wrapped their code in an easy to use library.</p>
<ul>
<li><a href="#usage">Usage</a></li>
<li><a href="#calibration">Calibration</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md1"></a>
Usage</h1>
<p >This library comprises only one class <code><a class="el" href="class_voltage_reference.html">VoltageReference</a></code> which requires to be initialized by invoking it's <code>begin()</code> function which can optionally accept a calibration value (more on calibration later on) in two formats: either as an unsigned long or as three single bytes (to ease calibration value storage into internal EEPROM).</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="class_voltage_reference.html">VoltageReference</a> vRef = <a class="code hl_class" href="class_voltage_reference.html">VoltageReference</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">  vRef.<a class="code hl_function" href="class_voltage_reference.html#a10a2a9f2f250d4090fb2a31119af58a2">begin</a>();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> loop() {</div>
<div class="line">  <span class="keywordtype">int</span> vcc = vRef.<a class="code hl_function" href="class_voltage_reference.html#a25c4c35bd11f4ca5029581e2c1fd708a">readVcc</a>();</div>
<div class="line">  <span class="comment">// vcc is the voltage at Vcc pin</span></div>
<div class="line">  </div>
<div class="line">  <span class="keywordtype">int</span> v11 = vRef.<a class="code hl_function" href="class_voltage_reference.html#ac7e3d75c20cc53d43a56f69db736d3dc">internalValue</a>();</div>
<div class="line">  <span class="comment">// v11 is the real internal voltage reference value</span></div>
<div class="line">  </div>
<div class="line">  <span class="keywordtype">int</span> a0 = analogRead(A0);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// usually to convert a0 to millivolts</span></div>
<div class="line">  <span class="keywordtype">int</span> oldPinV = a0 / 1024 * 5000; <span class="comment">// for a 3.3V board use 3300</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// more precise result can be obtained with</span></div>
<div class="line">  <span class="keywordtype">int</span> betterPinV = a0 / 1024 * vcc;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// when playing with low voltages</span></div>
<div class="line">  analogReference(INTERNAL);</div>
<div class="line">  <span class="keywordtype">int</span> a1 = analogRead(A1);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// usually to convert a1 to millivolts</span></div>
<div class="line">  <span class="keywordtype">int</span> oldPinLowV = a1 / 1024 * 1100;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// the most accurate low voltage readings are obtained with</span></div>
<div class="line">  <span class="keywordtype">int</span> accuratePinLowV = a1 / 1024 * v11;</div>
<div class="line">}</div>
<div class="ttc" id="aclass_voltage_reference_html"><div class="ttname"><a href="class_voltage_reference.html">VoltageReference</a></div><div class="ttdef"><b>Definition:</b> VoltageReference.h:33</div></div>
<div class="ttc" id="aclass_voltage_reference_html_a10a2a9f2f250d4090fb2a31119af58a2"><div class="ttname"><a href="class_voltage_reference.html#a10a2a9f2f250d4090fb2a31119af58a2">VoltageReference::begin</a></div><div class="ttdeci">void begin(uint32_t reference=DEFAULT_REFERENCE_CALIBRATION)</div><div class="ttdef"><b>Definition:</b> VoltageReference.cpp:22</div></div>
<div class="ttc" id="aclass_voltage_reference_html_a25c4c35bd11f4ca5029581e2c1fd708a"><div class="ttname"><a href="class_voltage_reference.html#a25c4c35bd11f4ca5029581e2c1fd708a">VoltageReference::readVcc</a></div><div class="ttdeci">uint16_t readVcc()</div><div class="ttdef"><b>Definition:</b> VoltageReference.cpp:52</div></div>
<div class="ttc" id="aclass_voltage_reference_html_ac7e3d75c20cc53d43a56f69db736d3dc"><div class="ttname"><a href="class_voltage_reference.html#ac7e3d75c20cc53d43a56f69db736d3dc">VoltageReference::internalValue</a></div><div class="ttdeci">uint16_t internalValue()</div><div class="ttdef"><b>Definition:</b> VoltageReference.cpp:56</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2"></a>
Calibration</h1>
<p >The principle is to use the internal microcontroller voltage reference of 1.1V to calculate the voltage powering the board and then use that as a reference instead of assuming your board is powered by a 5V or a 3.3V source: the latter is a big assumption in many situations, especially those where your voltage source is a battery (which produces a variable voltage).</p>
<p >While this usually already produces a better result than just assuming your board is powered perfectly and stable, this still introduces some variations as the internal microcontroller voltage reference is subject to construction differences (impurities in the materials and that kind of stuff): to improve a little more your readings accuracy a per board/microcontroller calibration step is strongly recommended.</p>
<p >Using a multimeter (better the multimeter accuracy, better the calibration, better analog readings) you need to measure the voltage difference between the Vcc/5V pin and GND pin when your board is powered but with no load (nothing connected to either of those two pins). Let's say your multimeter reads 4.97V.</p>
<p >Now load the <code>EEPROMCalibration</code> example sketch onto your board/microcontroller and run it opening a connection to the serial port: you should obtain the following output.</p>
<div class="fragment"><div class="line">--- MENU ---</div>
<div class="line">  R to read Vcc</div>
<div class="line">  L to load calibration from EEPROM</div>
<div class="line">  S to store calibration into EEPROM</div>
<div class="line">  C to clear calibration from EEPROM</div>
<div class="line">  dddd (4 digits) to calibrate for mV</div>
<div class="line">  A to print EEPROM calibration start address (length 3)</div>
<div class="line">  Adddd (4 digits) to set EEPROM calibration start address (length 3)</div>
<div class="line">  H prints this help</div>
</div><!-- fragment --><p >Now send <code>R</code> and let's compare the voltage measured by your microcontroller with the one measured by your multimeter: if they match you got lucky as both your microcontroller and your multimeter have the same error (yeah, none of them will be 100% accurate, trust me)!</p>
<p >In case they differ slightly then here we can step in and calibrate the microcontroller so that it will closely match your multimeter in the future (if you used a decent multimeter that should improve your readings).</p>
<p >By the menu above, you just send on serial the 4 digits representing your multimeter reading in millivolts: 4.97 * 1000 = 4970. You should get something like the following on the serial console, with the last number being a little higher or lower than the displayed one:</p>
<div class="fragment"><div class="line">Calibrating for Vcc 4970mV</div>
<div class="line">Calibration value is 1123220</div>
</div><!-- fragment --><p >Bingo! That is the number you should provide as input parameter to the <code><a class="el" href="class_voltage_reference.html#a10a2a9f2f250d4090fb2a31119af58a2">VoltageReference::begin()</a></code> function <em><b>for this specific board/micro controller</b></em>.</p>
<p >You can use the calibration sketch to store this value into the internal microcontroller EEPROM memory and read it from there in the future: just send <code>S</code> on the serial console to have it stored in the default location (using the very last 3 bytes of the internal flash memory).</p>
<p >In your sketch, use the following code to initialize the library, but remember, the calibration value changes per each board/processor you use!</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;EEPROM.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;VoltageReference.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// sets the storage area to the very end of the EEPROM, matching the one used by the calibration sketch</span></div>
<div class="line"><span class="preprocessor">#define VREF_EEPROM_ADDR (E2END - 2)</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="class_voltage_reference.html">VoltageReference</a> vRef;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">  vRef.<a class="code hl_function" href="class_voltage_reference.html#a10a2a9f2f250d4090fb2a31119af58a2">begin</a>(EEPROM.read(VREF_EEPROM_ADDR), EEPROM.read(VREF_EEPROM_ADDR + 1), EEPROM.read(VREF_EEPROM_ADDR + 2));</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
